{% extends "base.html" %}

{% set sidebar_actions_parent = 'admin:webhooks' %}
{% set sidebar_actions %}
<div class="nav-actions">
  <button class="secondary-button" type="button" data-action="webhook-refresh">Refresh</button>
</div>
{% endset %}

{% block content %}
  <section class="panel">
    <header class="panel__header">
      <div>
        <h2>Webhook retry monitor</h2>
        <p>Track failed outbound notifications and confirm that automatic retries are scheduled.</p>
      </div>
    </header>
    <div class="panel__body">
      <div class="table-actions">
        <input type="search" placeholder="Filter webhooks" data-role="table-filter" aria-label="Filter webhook events" />
      </div>
      <div class="form-message" data-role="webhook-message" aria-live="polite"></div>
      <div class="table-wrapper">
        <table data-role="sortable-table" class="data-table">
          <thead>
            <tr>
              <th scope="col" data-sort-key="id">Webhook ID</th>
              <th scope="col" data-sort-key="module_slug">Module</th>
              <th scope="col" data-sort-key="request_url">Request</th>
              <th scope="col" data-sort-key="status">Status</th>
              <th scope="col" data-sort-key="response_status_code">HTTP status</th>
              <th scope="col" data-sort-key="last_attempt">Last attempt</th>
              <th scope="col" data-sort-key="next_retry">Next retry</th>
              <th scope="col" data-sort-key="result">Result</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for event in webhook_failures %}
            <tr data-webhook-row="{{ event.id }}">
              <td data-sort-value="{{ event.id }}">{{ event.id }}</td>
              <td data-cell="module" data-sort-value="{{ event.module_slug or '' }}">
                {{ event.module_slug or "—" }}
              </td>
              <td data-cell="request" data-sort-value="{{ event.request_url }}">
                <span class="request-method">{{ event.request_method }}</span>
                <span class="request-url">{{ event.request_url }}</span>
              </td>
              <td data-cell="status" data-sort-value="{{ event.status }}">{{ event.status_label }}</td>
              <td data-cell="response_status" data-sort-value="{{ event.response_status_code or 0 }}">
                {{ event.response_status_code or "—" }}
              </td>
              <td data-cell="last_attempt"
                data-sort-value="{{ event.last_attempt }}"
                {% if event.last_attempt %}data-format="datetime"{% endif %}
              >
                {{ event.last_attempt or "—" }}
              </td>
              <td data-cell="next_retry"
                data-sort-value="{{ event.next_retry }}"
                {% if event.next_retry %}data-format="datetime"{% endif %}
              >
                {{ event.next_retry or "Paused" }}
              </td>
              <td data-cell="result" data-sort-value="{{ event.error_message or event.response_payload or '' }}">
                <a class="secondary-button" href="{{ event.result_url }}" target="_blank" rel="noopener">
                  View result
                </a>
              </td>
              <td class="table-actions__cell">
                <div class="table-actions__group">
                  <button
                    class="secondary-button"
                    type="button"
                    data-action="webhook-pause"
                    data-webhook-id="{{ event.id }}"
                    {% if event.status == 'paused' %}hidden{% endif %}
                  >
                    Pause
                  </button>
                  <button
                    class="secondary-button"
                    type="button"
                    data-action="webhook-resume"
                    data-webhook-id="{{ event.id }}"
                    {% if event.status != 'paused' %}hidden{% endif %}
                  >
                    Resume
                  </button>
                  <button
                    class="secondary-button danger"
                    type="button"
                    data-action="webhook-delete"
                    data-webhook-id="{{ event.id }}"
                  >
                    Delete
                  </button>
                </div>
              </td>
            </tr>
            {% else %}
            <tr data-role="webhook-empty">
              <td colspan="9">All outbound webhooks are healthy.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="panel">
    <header class="panel__header">
      <div>
        <h2>Retry policy</h2>
        <p>Retries follow an exponential backoff and are capped to protect upstream services.</p>
      </div>
    </header>
    <div class="panel__body">
      <ul class="runbook-list">
        <li class="runbook-item">
          <div class="runbook-summary">
            <h3>Initial delay</h3>
            <p>First retry occurs 5 minutes after a failure, expanding to 30 minutes for persistent errors.</p>
          </div>
        </li>
        <li class="runbook-item">
          <div class="runbook-summary">
            <h3>Maximum attempts</h3>
            <p>Events are retried up to 12 times before escalation to the automation team.</p>
          </div>
        </li>
        <li class="runbook-item">
          <div class="runbook-summary">
            <h3>Manual intervention</h3>
            <p>Use the Tactical Desk API to pause retries while investigating and resume once the upstream service is stable.</p>
          </div>
        </li>
      </ul>
    </div>
  </section>
{% endblock %}
