{% extends "base.html" %}
{% block header_actions %}
<a class="secondary-button" href="{{ url_for('automation') }}">Back to automations</a>
{% endblock %}
{% block content %}
<section
  class="panel automation-editor"
  data-role="automation-edit-page"
  data-automation-id="{{ automation.id }}"
  data-automation-kind="{{ automation.kind }}"
  data-return-url="{{ url_for('automation') }}"
>
  <header class="panel__header">
    <div class="panel__intro">
      <span class="automation-editor__kind">Event-based automation</span>
      <h2 class="panel__title">{{ automation.name }}</h2>
      <p class="panel__subtitle">
        Choose application events that should trigger this automation and review recent signal delivery.
      </p>
    </div>
  </header>
  <div class="panel__body">
    <form
      data-role="automation-edit-form"
      data-trigger-filters='{{ automation.trigger_filters | tojson | safe }}'
      data-trigger-value="{{ automation.trigger or '' }}"
      data-ticket-actions='{{ automation.ticket_actions | tojson | safe }}'
      autocomplete="off"
    >
      <p class="automation-editor__hint">
        Triggers map to Tactical Desk events such as ticket creation, updates, and resolution workflows.
      </p>
      <div class="automation-editor__grid">
        <div class="form-field">
          <label for="automation-name">Name</label>
          <input
            id="automation-name"
            name="name"
            type="text"
            maxlength="255"
            required
            value="{{ automation.name }}"
          />
        </div>
        <div class="form-field">
          <label for="automation-playbook">Runbook label</label>
          <input
            id="automation-playbook"
            name="playbook"
            type="text"
            maxlength="255"
            required
            list="runbook-label-options"
            value="{{ automation.playbook }}"
          />
        </div>
        <div class="form-field automation-editor__grid-item--full">
          <label for="automation-description">Description</label>
          <textarea id="automation-description" name="description" rows="4" maxlength="2048">{{ automation.description or '' }}</textarea>
        </div>
        <div class="form-field">
          <label for="automation-trigger-match">Trigger logic</label>
          {% set selected_match = automation.trigger_filters.match if automation.trigger_filters else 'any' %}
          <select id="automation-trigger-match" name="trigger_match">
            <option value="any" {% if selected_match != 'all' %}selected{% endif %}>
              Match any selected trigger (OR)
            </option>
            <option value="all" {% if selected_match == 'all' %}selected{% endif %}>
              Require all selected triggers (AND)
            </option>
          </select>
        </div>
        <div class="form-field automation-editor__grid-item--full">
          <label>Conditions</label>
          <div
            class="trigger-conditions"
            data-role="trigger-conditions"
            data-trigger-options='{{ event_trigger_options | tojson | safe }}'
            data-value-required='{{ value_required_trigger_options | tojson | safe }}'
          >
            <div class="trigger-conditions__controls">
              <input
                type="search"
                class="trigger-conditions__filter"
                placeholder="Filter conditions"
                data-role="trigger-condition-filter"
                aria-label="Filter trigger conditions"
              />
            </div>
            <div class="trigger-conditions__table-wrapper">
              <table class="trigger-conditions__table" data-role="trigger-condition-table">
                <thead>
                  <tr>
                    <th scope="col">
                      <button type="button" class="trigger-conditions__sort" data-role="trigger-sort" data-sort-key="type" aria-label="Sort by trigger">
                        Trigger
                      </button>
                    </th>
                    <th scope="col">Operator</th>
                    <th scope="col">Value</th>
                    <th scope="col" class="trigger-conditions__actions-header">Actions</th>
                  </tr>
                </thead>
                <tbody class="trigger-conditions__list" data-role="trigger-condition-list"></tbody>
              </table>
            </div>
            <template data-role="trigger-condition-template">
              <tr class="trigger-condition" data-role="trigger-condition">
                <td data-column="type">
                  <select
                    class="trigger-condition__select"
                    data-role="trigger-condition-select"
                    aria-label="Trigger condition"
                  >
                    <option value="">Select a trigger</option>
                    {% for trigger in event_trigger_options %}
                    <option value="{{ trigger }}">{{ trigger }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td data-column="operator">
                  <select
                    class="trigger-condition__operator"
                    data-role="trigger-condition-operator"
                    aria-label="Trigger operator"
                  >
                    <option value="">Select an operator</option>
                    {% for value, label in trigger_operator_options %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td data-column="value">
                  <input
                    type="text"
                    class="trigger-condition__value"
                    data-role="trigger-condition-value"
                    placeholder="Enter value"
                    maxlength="255"
                  />
                </td>
                <td class="trigger-conditions__actions" data-column="actions">
                  <button
                    type="button"
                    class="icon-button trigger-condition__remove"
                    data-action="remove-trigger-condition"
                    aria-label="Remove condition"
                  >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </td>
              </tr>
            </template>
            <button
              type="button"
              class="link-button trigger-conditions__add"
              data-action="add-trigger-condition"
            >
              + Add new condition
            </button>
            <p class="form-help">Start with one condition and add more as needed.</p>
          </div>
        </div>
        <div class="form-field automation-editor__grid-item--full">
          <label>Ticket actions</label>
          <div
            class="ticket-actions"
            data-role="ticket-actions"
            data-action-options='{{ automation_actions | tojson | safe }}'
          >
            <div class="ticket-actions__controls">
              <input
                type="search"
                class="ticket-actions__filter"
                placeholder="Filter actions"
                data-role="ticket-action-filter"
                aria-label="Filter ticket actions"
              />
            </div>
            <div class="ticket-actions__table-wrapper">
              <table class="ticket-actions__table">
                <thead>
                  <tr>
                    <th scope="col">Action</th>
                    <th scope="col">Details</th>
                  </tr>
                </thead>
                <tbody class="ticket-actions__list" data-role="ticket-action-list"></tbody>
              </table>
            </div>
            <template data-role="ticket-action-template">
              <tr class="ticket-action" data-role="ticket-action">
                <td data-column="action">
                  <select
                    class="ticket-action__select"
                    data-role="ticket-action-select"
                    aria-label="Ticket action"
                    required
                  >
                    <option value="">Select an action</option>
                    {% for option in automation_actions %}
                    <option value="{{ option.slug }}">{{ option.name }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td data-column="value">
                  <div class="ticket-action__value-wrapper">
                    <textarea
                      class="ticket-action__value"
                      data-role="ticket-action-value"
                      rows="3"
                      maxlength="4096"
                      placeholder="Enter action details"
                      aria-label="Action details"
                      required
                    ></textarea>
                    <button
                      type="button"
                      class="icon-button ticket-action__remove"
                      data-action="remove-ticket-action"
                      aria-label="Remove ticket action"
                    >
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                </td>
              </tr>
            </template>
            <button
              type="button"
              class="link-button ticket-actions__add"
              data-action="add-ticket-action"
            >
              + Add ticket action
            </button>
            <p class="form-help">
              Assign one or more actions to execute after the trigger conditions are met.
            </p>
          </div>
        </div>
        <div class="form-field">
          <label for="automation-status">Status label</label>
          <input
            id="automation-status"
            name="status"
            type="text"
            maxlength="64"
            value="{{ automation.status or '' }}"
            placeholder="Active"
          />
        </div>
        <div class="form-field">
          <label for="automation-last-trigger">Last triggered</label>
          <input
            id="automation-last-trigger"
            name="last_trigger_at"
            type="datetime-local"
            step="60"
            data-automation-datetime
            data-iso-value="{{ automation.last_trigger_iso or '' }}"
          />
        </div>
      </div>
      <section
        class="automation-action-catalog"
        aria-labelledby="automation-action-catalog-title"
      >
        <div class="automation-action-catalog__header">
          <div class="automation-action-catalog__text">
            <h3
              class="automation-action-catalog__title"
              id="automation-action-catalog-title"
            >
              Available ticket actions
            </h3>
            <p class="automation-action-catalog__description">
              Actions execute after all trigger conditions evaluate to true and can be
              referenced in downstream runbook orchestration.
            </p>
          </div>
          <div class="automation-action-catalog__filter">
            <label class="visually-hidden" for="automation-action-filter">
              Filter ticket actions
            </label>
            <input
              id="automation-action-filter"
              type="search"
              class="automation-action-catalog__filter-input"
              placeholder="Filter actions"
              data-role="table-filter"
              aria-controls="automation-action-table"
            />
          </div>
        </div>
        <div class="table-container">
          <table
            id="automation-action-table"
            class="data-table automation-action-table"
            data-role="sortable-table"
          >
            <thead>
              <tr>
                <th scope="col" data-sort-key="action">Action</th>
                <th scope="col" data-sort-key="identifier">Identifier</th>
              </tr>
            </thead>
            <tbody>
              {% for action in automation_actions %}
              <tr>
                <td data-cell="action" data-sort-value="{{ action.name }}">
                  {{ action.name }}
                </td>
                <td data-cell="identifier" data-sort-value="{{ action.slug }}">
                  <code>{{ action.slug }}</code>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
      <div class="automation-editor__message" data-role="automation-message" role="status" aria-live="polite"></div>
      <div class="automation-editor__actions">
        <a class="secondary-button" href="{{ url_for('automation') }}">Cancel</a>
        <button class="primary-button" type="submit" data-role="automation-submit">Save changes</button>
      </div>
    </form>
  </div>
</section>
<datalist id="runbook-label-options">
  {% for label in runbook_labels %}
  <option value="{{ label.label }}"></option>
  {% endfor %}
</datalist>
{% endblock %}
