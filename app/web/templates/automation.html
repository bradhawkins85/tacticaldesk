{% extends "base.html" %}
{% block header_actions %}
<button class="primary-button" type="button" data-action="launch-runbook">Launch runbook</button>
<button class="secondary-button" type="button" data-action="view-logs">View logs</button>
{% endblock %}
{% block content %}
<section class="content-section">
  <header class="section-header">
    <h2>Orchestration runs</h2>
    <p class="subtitle">Observe workflow execution and confirm remediation timelines.</p>
  </header>
  <div class="table-toolbar">
    <label class="filter">
      <span>Filter</span>
      <input type="search" placeholder="Search workflows" data-role="table-filter" aria-controls="orchestration-table" />
    </label>
  </div>
  <div class="table-wrapper">
    <table id="orchestration-table" class="data-table" data-role="sortable-table">
      <thead>
        <tr>
          <th scope="col" data-sort-key="workflow">Workflow</th>
          <th scope="col" data-sort-key="status">Status</th>
          <th scope="col" data-sort-key="duration_minutes">Duration (min)</th>
          <th scope="col" data-sort-key="finished">Last completed</th>
        </tr>
      </thead>
      <tbody>
        {% for run in orchestration_runs %}
        <tr>
          <td data-label="Workflow">{{ run.workflow }}</td>
          <td data-label="Status"><span class="badge status-{{ run.status | lower }}">{{ run.status }}</span></td>
          <td data-label="Duration (min)" data-sort-value="{{ run.duration_minutes }}">{{ run.duration_minutes }}</td>
          <td
            data-label="Last completed"
            data-sort-value="{{ run.finished_iso }}"
            {% if run.finished_iso %}data-format="datetime"{% endif %}
          >
            {{ run.finished_iso or "In progress" }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
<section class="content-section">
  <header class="section-header">
    <h2>Integration modules</h2>
    <p class="subtitle">Control which external systems Tactical Desk connects to for automation.</p>
  </header>
  <div class="table-toolbar">
    <label class="filter">
      <span>Filter</span>
      <input type="search" placeholder="Search modules" data-role="table-filter" aria-controls="modules-table" />
    </label>
    <div class="form-message" data-role="integration-message" aria-live="polite"></div>
  </div>
  <div class="table-wrapper">
    <table id="modules-table" class="data-table" data-role="sortable-table">
      <thead>
        <tr>
          <th scope="col" data-sort-key="module">Integration</th>
          <th scope="col" data-sort-key="enabled">Enabled</th>
          <th scope="col" data-sort-key="updated">Last updated</th>
        </tr>
      </thead>
      <tbody>
        {% for module in module_toggles %}
        <tr data-integration-row="{{ module.slug }}">
          <td data-label="Integration">
            <div class="integration-row">
              <span class="integration-row__icon" aria-hidden="true">{{ module.icon }}</span>
              <div class="integration-row__content">
                <span class="integration-row__name">{{ module.module }}</span>
                <a class="integration-row__link" href="{{ url_for('integration_detail', slug=module.slug) }}">Configure</a>
              </div>
            </div>
          </td>
          <td data-label="Enabled" data-sort-value="{{ 1 if module.enabled else 0 }}">
            <div class="integration-toggle">
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  data-role="integration-toggle"
                  data-slug="{{ module.slug }}"
                  {% if module.enabled %}checked{% endif %}
                  aria-label="Toggle {{ module.module }} integration"
                />
                <span class="toggle-slider" aria-hidden="true"></span>
              </label>
              <span
                class="badge {{ 'status-open' if module.enabled else 'status-waiting' }}"
                data-role="integration-status-label"
              >
                {{ 'Enabled' if module.enabled else 'Disabled' }}
              </span>
            </div>
          </td>
          <td
            data-label="Last updated"
            data-sort-value="{{ module.updated_at_iso or '' }}"
            {% if module.updated_at_iso %}data-format="datetime"{% endif %}
          >
            {{ module.updated_at_iso or "Not configured" }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
<section class="panel automation-update">
  <header class="panel__header">
    <div>
      <h2>Lifecycle automation</h2>
      <p>Securely execute platform maintenance jobs without leaving the control tower.</p>
    </div>
  </header>
  <div class="panel__body">
    <div class="automation-update__actions">
      <button
        class="primary-button"
        type="button"
        data-action="maintenance-run"
        data-endpoint="/maintenance/update"
        data-output="#automation-update-output"
      >
        Run secure update
      </button>
      <p class="automation-update__help">
        Uses the hardened update script to pull vetted releases, install dependencies, run migrations, and restart
        services. Requests respect the installer lock so only authorized operators can trigger execution.
      </p>
    </div>
    <div class="log-console" aria-live="polite">
      <h3>Update status</h3>
      <pre id="automation-update-output">Awaiting update commandâ€¦</pre>
    </div>
  </div>
</section>
{% endblock %}
