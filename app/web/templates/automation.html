{% extends "base.html" %}
{% set sidebar_actions_parent = 'admin:automation' %}
{% set sidebar_actions %}
<div class="nav-actions">
  <div class="nav-actions__group">
    <a class="primary-button" href="{{ url_for('automation_create_event') }}">New event automation</a>
    <a class="secondary-button" href="{{ url_for('automation_create_scheduled') }}">New scheduled automation</a>
  </div>
</div>
{% endset %}
{% block content %}
<section class="panel automation-section">
  <header class="panel__header">
    <div>
      <h2>Scheduled automations</h2>
      <p>Recurring jobs that enforce platform hygiene, resilience, and compliance.</p>
    </div>
    <div class="panel__tools">
      <label class="visually-hidden" for="scheduled-automation-filter">Filter scheduled automations</label>
      <input
        id="scheduled-automation-filter"
        type="search"
        placeholder="Filter scheduled automations"
        data-role="table-filter"
        aria-controls="scheduled-automation-table"
      />
    </div>
  </header>
  <div class="panel__body">
    <div class="table-container">
      <table id="scheduled-automation-table" class="data-table" data-role="sortable-table">
        <thead>
          <tr>
            <th scope="col" data-sort-key="name">Automation</th>
            <th scope="col" data-sort-key="runbook">Runbook label</th>
            <th scope="col" data-sort-key="cron">Cron schedule</th>
            <th scope="col" data-sort-key="next_run">Next run</th>
            <th scope="col" data-sort-key="last_run">Last run</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for automation in scheduled_automations %}
          <tr
            data-automation-row="true"
            data-automation-id="{{ automation.id }}"
            data-automation-kind="{{ automation.kind }}"
            data-automation='{{ automation | tojson | safe }}'
          >
            <th scope="row">
              <div class="automation-name">
                <span class="automation-name__title">{{ automation.name }}</span>
                <p class="automation-name__description">{{ automation.description }}</p>
              </div>
            </th>
            <td data-cell="runbook" data-sort-value="{{ automation.playbook }}">{{ automation.playbook }}</td>
            <td data-cell="cron" data-sort-value="{{ automation.cron_expression or '' }}">
              {{ automation.cron_expression or '—' }}
            </td>
            <td data-cell="next_run" data-sort-value="{{ automation.next_run_iso or '' }}">
              {% if automation.next_run_iso %}
              <time data-role="local-datetime" datetime="{{ automation.next_run_iso }}">{{ automation.next_run_iso }}</time>
              {% else %}
              <span class="automation-placeholder">—</span>
              {% endif %}
            </td>
            <td data-cell="last_run" data-sort-value="{{ automation.last_run_iso or '' }}">
              {% if automation.last_run_iso %}
              <time data-role="local-datetime" datetime="{{ automation.last_run_iso }}">{{ automation.last_run_iso }}</time>
              {% else %}
              <span class="automation-placeholder">—</span>
              {% endif %}
            </td>
            <td data-cell="actions">
              <div class="automation-actions">
                {% if automation.action %}
                <button
                  class="icon-button icon-button--play"
                  type="button"
                  data-action="maintenance-run"
                  data-endpoint="{{ automation.action.endpoint }}"
                  data-output="{{ automation.action.output_selector }}"
                  aria-label="Run {{ automation.name }}"
                  title="Run {{ automation.action.label }}"
                >
                  ▶
                </button>
                {% elif automation.manual_run_endpoint %}
                <button
                  class="icon-button icon-button--play"
                  type="button"
                  data-action="automation-run"
                  data-endpoint="{{ automation.manual_run_endpoint }}"
                  data-feedback="#automation-update-output"
                  aria-label="Run {{ automation.name }}"
                  title="Run {{ automation.name }} manually"
                >
                  ▶
                </button>
                {% endif %}
                {% if not automation.action %}
                <span class="automation-status-tag">Monitored</span>
                {% endif %}
                <a
                  class="icon-button icon-button--edit"
                  href="{{ url_for('automation_edit_scheduled', automation_id=automation.id) }}"
                  aria-label="Edit {{ automation.name }}"
                  title="Edit {{ automation.name }}"
                >
                  ✏️
                </a>
                <button
                  class="icon-button icon-button--danger"
                  type="button"
                  data-action="automation-delete"
                  data-endpoint="{{ automation.delete_endpoint }}"
                  data-feedback="#automation-update-output"
                  aria-label="Delete {{ automation.name }}"
                  title="Delete {{ automation.name }}"
                >
                  ✖
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="log-console" aria-live="polite">
      <h3>Secure update status</h3>
      <pre id="automation-update-output">Awaiting update command…</pre>
    </div>
  </div>
</section>

<section class="panel automation-section">
  <header class="panel__header">
    <div>
      <h2>Event-based automations</h2>
      <p>Reactive runbooks that execute when specific security or operational signals fire.</p>
    </div>
    <div class="panel__tools">
      <label class="visually-hidden" for="event-automation-filter">Filter event automations</label>
      <input
        id="event-automation-filter"
        type="search"
        placeholder="Filter event automations"
        data-role="table-filter"
        aria-controls="event-automation-table"
      />
    </div>
  </header>
  <div class="panel__body">
    <div class="table-container">
      <table id="event-automation-table" class="data-table" data-role="sortable-table">
        <thead>
          <tr>
            <th scope="col" data-sort-key="name">Automation</th>
            <th scope="col" data-sort-key="runbook">Runbook label</th>
            <th scope="col" data-sort-key="trigger">Trigger</th>
            <th scope="col" data-sort-key="last_trigger">Last triggered</th>
            <th scope="col" data-sort-key="status">Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for automation in event_automations %}
          <tr
            data-automation-row="true"
            data-automation-id="{{ automation.id }}"
            data-automation-kind="{{ automation.kind }}"
            data-automation='{{ automation | tojson | safe }}'
          >
            <th scope="row">
              <div class="automation-name">
                <span class="automation-name__title">{{ automation.name }}</span>
                <p class="automation-name__description">{{ automation.description }}</p>
              </div>
            </th>
            <td data-cell="runbook" data-sort-value="{{ automation.playbook }}">{{ automation.playbook }}</td>
            <td data-cell="trigger" data-sort-value="{{ automation.trigger_sort or '' }}">{{ automation.trigger_display }}</td>
            <td data-cell="last_trigger" data-sort-value="{{ automation.last_trigger_iso or '' }}">
              {% if automation.last_trigger_iso %}
              <time data-role="local-datetime" datetime="{{ automation.last_trigger_iso }}">{{ automation.last_trigger_iso }}</time>
              {% else %}
              <span class="automation-placeholder">—</span>
              {% endif %}
            </td>
            <td data-cell="status" data-sort-value="{{ automation.status or '' }}">
              {% if automation.status %}
              <span class="automation-status-tag">{{ automation.status }}</span>
              {% else %}
              <span class="automation-placeholder">—</span>
              {% endif %}
            </td>
            <td data-cell="actions">
              <div class="automation-actions">
                <a
                  class="icon-button icon-button--edit"
                  href="{{ url_for('automation_edit_event', automation_id=automation.id) }}"
                  aria-label="Edit {{ automation.name }}"
                  title="Edit {{ automation.name }}"
                >
                  ✏️
                </a>
                <button
                  class="icon-button icon-button--danger"
                  type="button"
                  data-action="automation-delete"
                  data-endpoint="{{ automation.delete_endpoint }}"
                  data-feedback="#automation-update-output"
                  aria-label="Delete {{ automation.name }}"
                  title="Delete {{ automation.name }}"
                >
                  ✖
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<section class="panel automation-section runbook-panel">
  <header class="panel__header">
    <div>
      <h2>Runbook labels</h2>
      <p>Review runbook label coverage and rename labels to keep automation taxonomies clean.</p>
    </div>
    <div class="panel__tools">
      <label class="visually-hidden" for="runbook-label-filter">Filter runbook labels</label>
      <input
        id="runbook-label-filter"
        type="search"
        placeholder="Filter runbook labels"
        data-role="table-filter"
        aria-controls="runbook-label-table"
      />
    </div>
  </header>
  <div class="panel__body">
    <div class="table-container">
      <table id="runbook-label-table" class="data-table" data-role="sortable-table">
        <thead>
          <tr>
            <th scope="col" data-sort-key="label">Runbook label</th>
            <th scope="col" data-sort-key="automation_count">Automations</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if runbook_labels %}
          {% for label in runbook_labels %}
          <tr data-runbook-label-row data-label="{{ label.label }}">
            <th scope="row" data-sort-value="{{ label.label | lower }}">
              <div class="runbook-name">
                <span class="runbook-name__title">{{ label.label }}</span>
              </div>
            </th>
            <td class="runbook-count" data-sort-value="{{ label.automation_count }}">{{ label.automation_count }}</td>
            <td class="runbook-actions">
              <button
                class="icon-button"
                type="button"
                data-action="rename-runbook-label"
                data-label="{{ label.label }}"
                title="Rename {{ label.label }}"
                aria-label="Rename {{ label.label }}"
              >
                ✏️
              </button>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr class="runbook-empty">
            <td colspan="3">No runbook labels found. Add an automation to create the first label.</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</section>

{% endblock %}
