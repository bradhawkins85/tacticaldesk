{% extends "base.html" %}
{% set sidebar_actions_parent = 'admin:integrations' %}
{% set sidebar_actions %}
<div class="nav-actions">
  <a class="secondary-button" href="{{ url_for('integrations_index') }}">All integrations</a>
</div>
{% endset %}
{% block content %}
<section class="content-section integration-header">
  <header class="section-header">
    <h2>{{ module.name }}</h2>
    <p class="subtitle">{{ module.description or "Securely manage credentials, webhooks, and automation access." }}</p>
  </header>
  <div class="integration-status-card">
    <div class="integration-status-card__icon" aria-hidden="true">{{ module.icon }}</div>
    <div class="integration-status-card__body">
      <p class="integration-status-card__state">
        <span class="badge {{ 'status-open' if module.enabled else 'status-waiting' }}" data-role="integration-status-label">
          {{ 'Enabled' if module.enabled else 'Disabled' }}
        </span>
      </p>
      <dl class="integration-status-card__meta">
        <div>
          <dt>Last updated</dt>
          <dd data-role="integration-updated" data-format="datetime" data-sort-value="{{ module.updated_at_iso or '' }}">
            {{ module.updated_at_iso or "Not configured" }}
          </dd>
        </div>
        <div>
          <dt>Created</dt>
          <dd data-format="datetime" data-sort-value="{{ module.created_at_iso or '' }}">
            {{ module.created_at_iso or "Unknown" }}
          </dd>
        </div>
      </dl>
    </div>
    <div class="integration-status-card__action">
      <label class="toggle-switch">
        <input
          type="checkbox"
          data-role="integration-toggle"
          data-slug="{{ module.slug }}"
          {% if module.enabled %}checked{% endif %}
          aria-label="Toggle {{ module.name }} integration"
        />
        <span class="toggle-slider" aria-hidden="true"></span>
      </label>
      <p class="integration-status-card__hint">Enable to surface this connector throughout Tactical Desk.</p>
    </div>
  </div>
  <div class="form-message" data-role="integration-message" aria-live="polite"></div>
</section>
<section class="content-section">
  {% if module.slug == "https-post-receiver" %}
  <header class="section-header">
    <h2>HTTPS POST webhook endpoint</h2>
    <p class="subtitle">
      Accept HTTPS POST calls from any service and automatically expose the payload to Tactical Desk automations. No
      credential configuration is required for this connector.
    </p>
  </header>
  <div class="integration-endpoint">
    <dl class="integration-endpoint__meta">
      <div>
        <dt>HTTP method</dt>
        <dd><code>POST</code></dd>
      </div>
      <div>
        <dt>Endpoint URL</dt>
        <dd>
          <code data-role="https-post-endpoint">{{ https_post_webhook_endpoint }}</code>
        </dd>
      </div>
    </dl>
    <div class="integration-endpoint__details">
      <p>
        Point any third-party webhook or HTTPS integration to this endpoint. Tactical Desk logs the inbound request,
        maps common fields to standard variables, and makes them available to downstream playbooks.
      </p>
      <p>
        Sample <code>curl</code> request:
      </p>
      <pre class="code-block"><code>curl -X POST {{ https_post_webhook_endpoint }} \
  -H "Content-Type: application/json" \
  -d '{"summary": "Ticket escalated", "details": "Service Desk raised an urgent ticket"}'</code></pre>
    </div>
  </div>
  {% elif module.slug == "syncro-rmm" %}
  <header class="section-header">
    <h2>Syncro data import</h2>
    <p class="subtitle">
      Bring Syncro companies and ticket history into Tactical Desk on demand. Imports honour your configured
      credentials and retry policies.
    </p>
  </header>
  {% if not module.enabled %}
  <div class="notice">
    Enable the integration to fetch companies and run imports. Controls remain locked until the connector is
    active.
  </div>
  {% endif %}
  <div
    class="syncro-import-grid"
    data-role="syncro-import"
    data-integration-slug="{{ module.slug }}"
    data-integration-enabled="{{ 'true' if module.enabled else 'false' }}"
  >
    <div class="syncro-import__status">
      <div class="form-message" data-role="syncro-import-message" aria-live="polite"></div>
    </div>
    <form
      id="integration-settings-form"
      class="panel integration-form syncro-import__credentials"
      data-slug="{{ module.slug }}"
    >
      <header class="panel__header">
        <div class="panel__intro">
          <h3 class="panel__title">Credentials &amp; endpoints</h3>
          <p class="panel__subtitle">
            Securely store your Syncro base URL and API key. Values are encrypted and only used when issuing import
            requests.
          </p>
        </div>
      </header>
      <div class="integration-form__grid">
        {% for field in settings_fields %}
        <label class="form-field">
          <span>{{ field.label }}</span>
          <input
            type="{{ field.type }}"
            name="{{ field.key }}"
            value="{{ module.settings.get(field.key, '') }}"
            placeholder="{{ field.placeholder }}"
            autocomplete="off"
          />
        </label>
        {% endfor %}
      </div>
      <div class="form-actions">
        <button class="primary-button" type="submit">Save changes</button>
        <div class="form-message" data-role="form-message" aria-live="polite"></div>
      </div>
    </form>
    <div class="syncro-import-grid__column">
      <form class="panel syncro-import__form" data-role="syncro-import-form">
        <header class="panel__header">
          <div class="panel__intro">
            <h3 class="panel__title">Ticket scope</h3>
            <p class="panel__subtitle">
              Control which Syncro tickets are ingested alongside the selected companies.
            </p>
          </div>
        </header>
        <div class="panel__body">
          <label class="form-field" for="syncro-ticket-mode">
            <span>Ticket import mode</span>
            <select
              id="syncro-ticket-mode"
              name="ticket_mode"
              data-role="syncro-ticket-mode"
              data-syncro-lock="true"
              {% if not module.enabled %}disabled{% endif %}
            >
              <option value="all">All open and recent tickets</option>
              <option value="single">Single ticket</option>
              <option value="range">Ticket number range</option>
            </select>
            <span class="form-field__hint">
              Ticket timestamps are stored in UTC and rendered in your local timezone for operators.
            </span>
          </label>
          <div class="form-field" data-role="syncro-ticket-single" hidden>
            <label for="syncro-ticket-number">Ticket number</label>
            <input
              id="syncro-ticket-number"
              type="number"
              min="1"
              inputmode="numeric"
              data-role="syncro-ticket-number"
              data-syncro-lock="true"
              placeholder="Enter ticket number"
              {% if not module.enabled %}disabled{% endif %}
            />
            <span class="form-field__hint">Import a specific Syncro ticket by its number.</span>
          </div>
          <div class="form-field syncro-import__range" data-role="syncro-ticket-range" hidden>
            <label for="syncro-ticket-range-start">Ticket number range</label>
            <div class="syncro-import__range-fields">
              <input
                id="syncro-ticket-range-start"
                type="number"
                min="1"
                inputmode="numeric"
                data-role="syncro-range-start"
                data-syncro-lock="true"
                placeholder="Start"
                {% if not module.enabled %}disabled{% endif %}
              />
              <span aria-hidden="true" class="syncro-import__range-separator">to</span>
              <input
                id="syncro-ticket-range-end"
                type="number"
                min="1"
                inputmode="numeric"
                data-role="syncro-range-end"
                data-syncro-lock="true"
                placeholder="End"
                {% if not module.enabled %}disabled{% endif %}
              />
            </div>
            <span class="form-field__hint">Specify an inclusive ticket range for bulk import.</span>
          </div>
        </div>
        <div class="form-actions">
          <button
            class="primary-button"
            type="submit"
            data-action="syncro-import-tickets"
            data-syncro-lock="true"
            {% if not module.enabled %}disabled{% endif %}
          >
            Import tickets
          </button>
        </div>
        <div class="form-message" data-role="syncro-import-form-message" aria-live="polite"></div>
        <div class="syncro-import__summary" data-role="syncro-import-summary" hidden>
          <h4 class="syncro-import__summary-title">Most recent run</h4>
          <dl class="syncro-import__metrics">
            <div class="syncro-import__metric">
              <dt>Companies created</dt>
              <dd data-stat="companies-created">0</dd>
            </div>
            <div class="syncro-import__metric">
              <dt>Companies updated</dt>
              <dd data-stat="companies-updated">0</dd>
            </div>
            <div class="syncro-import__metric">
              <dt>Tickets imported</dt>
              <dd data-stat="tickets-imported">0</dd>
            </div>
            <div class="syncro-import__metric">
              <dt>Tickets skipped</dt>
              <dd data-stat="tickets-skipped">0</dd>
            </div>
            <div class="syncro-import__metric">
              <dt>Last synced</dt>
              <dd data-stat="last-synced">â€”</dd>
            </div>
          </dl>
        </div>
      </form>
    </div>
    <div class="syncro-import-grid__column">
      <div class="panel">
        <header class="panel__header">
          <div class="panel__intro">
            <h3 class="panel__title">Companies</h3>
            <p class="panel__subtitle">
              Select the Syncro customers you want to synchronize. Leave all unchecked to import every accessible
              company.
            </p>
          </div>
          <div class="panel__tools">
            <div class="panel__tools-group panel__tools-group--filter">
              <label class="visually-hidden" for="syncro-company-filter">Search companies</label>
              <input
                id="syncro-company-filter"
                type="search"
                placeholder="Filter companies"
                data-role="table-filter"
                data-syncro-lock="true"
                {% if not module.enabled %}disabled{% endif %}
              />
            </div>
            <div class="panel__tools-group panel__tools-group--actions">
              <span class="syncro-import__selection">
                <strong data-role="syncro-selection-count">0</strong>
                selected
              </span>
              <button
                class="primary-button"
                type="button"
                data-action="syncro-import-companies"
                data-syncro-lock="true"
                {% if not module.enabled %}disabled{% endif %}
              >
                Import companies
              </button>
              <button
                class="secondary-button"
                type="button"
                data-action="syncro-refresh-companies"
                data-syncro-lock="true"
                {% if not module.enabled %}disabled{% endif %}
              >
                Refresh companies
              </button>
            </div>
          </div>
        </header>
        <div class="panel__body">
          <div
            class="form-message"
            data-role="syncro-companies-message"
            aria-live="polite"
          ></div>
          <div class="table-wrapper">
            <table class="data-table" data-role="sortable-table" data-syncro-company-table="true">
              <thead>
                <tr>
                  <th scope="col">
                    <label class="visually-hidden" for="syncro-company-select-all">Select all companies</label>
                    <input
                      id="syncro-company-select-all"
                      type="checkbox"
                      data-role="syncro-select-all"
                      data-syncro-lock="true"
                      {% if not module.enabled %}disabled{% endif %}
                    />
                  </th>
                  <th scope="col" data-sort-key="name">Company</th>
                  <th scope="col" data-sort-key="external_id">Syncro ID</th>
                  <th scope="col" data-sort-key="contact">Primary contact</th>
                </tr>
              </thead>
              <tbody data-role="syncro-company-tbody">
                <tr data-role="syncro-empty-row">
                  <td colspan="4">Enable the integration to load Syncro companies.</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="table-pagination" data-role="syncro-pagination" hidden>
            <div class="table-pagination__controls">
              <button
                class="secondary-button"
                type="button"
                data-role="syncro-page-prev"
                data-syncro-lock="true"
                {% if not module.enabled %}disabled{% endif %}
              >
                Previous
              </button>
              <span class="table-pagination__status" data-role="syncro-page-status">
                Showing 0 of 0
              </span>
              <button
                class="secondary-button"
                type="button"
                data-role="syncro-page-next"
                data-syncro-lock="true"
                {% if not module.enabled %}disabled{% endif %}
              >
                Next
              </button>
            </div>
            <label class="form-field form-field--inline table-pagination__page-size">
              <span class="form-field__label">Rows per page</span>
              <select
                data-role="syncro-page-size"
                data-syncro-lock="true"
                {% if not module.enabled %}disabled{% endif %}
              >
                <option value="5" selected>5</option>
                <option value="10">10</option>
                <option value="25">25</option>
              </select>
            </label>
          </div>
        </div>
        <footer class="panel__footer">
          Tactical Desk monitors outbound webhook deliveries and retries failed Syncro calls automatically.
        </footer>
      </div>
    </div>
  </div>
  {% else %}
  <header class="section-header">
    <h2>Credentials &amp; endpoints</h2>
    <p class="subtitle">Update connection details. Values are stored encrypted and used for outbound API calls.</p>
  </header>
  <form id="integration-settings-form" class="integration-form" data-slug="{{ module.slug }}">
    <div class="integration-form__grid">
      {% for field in settings_fields %}
      <label class="form-field">
        <span>{{ field.label }}</span>
        <input
          type="{{ field.type }}"
          name="{{ field.key }}"
          value="{{ module.settings.get(field.key, '') }}"
          placeholder="{{ field.placeholder }}"
          autocomplete="off"
        />
      </label>
      {% endfor %}
    </div>
    <div class="form-actions">
      <button class="primary-button" type="submit">Save changes</button>
      <div class="form-message" data-role="form-message" aria-live="polite"></div>
    </div>
  </form>
  {% endif %}
</section>
<section class="panel integration-guidance">
  <header class="panel__header">
    <div>
      <h2>Security notes</h2>
      <p>Webhook deliveries are monitored and failed attempts are retried automatically with exponential backoff.</p>
    </div>
  </header>
  <div class="panel__body">
    <ul class="guidance-list">
      <li>Store timestamps in UTC. Tactical Desk renders them in the operator's local timezone.</li>
      <li>Rotate secrets regularly and audit enable/disable events via the webhook operations dashboard.</li>
      <li>Use the automation workspace to validate integration runbooks after credentials change.</li>
    </ul>
  </div>
</section>
{% endblock %}
