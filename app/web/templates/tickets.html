{% extends "base.html" %}
{% set sidebar_actions_parent = 'tickets' %}
{% set sidebar_actions %}
<div class="nav-actions">
  <label class="nav-field" for="ticket-sort-select">
    <span class="nav-field__label">Sort</span>
    <select id="ticket-sort-select" name="ticket-sort" class="nav-field__control">
      {% for option in ticket_sort_options %}
      <option value="{{ option.value }}"{% if loop.first %} selected{% endif %}>{{ option.label }}</option>
      {% endfor %}
    </select>
  </label>
  <label class="nav-field" for="asset-visibility-select">
    <span class="nav-field__label">Assets visibility</span>
    <select id="asset-visibility-select" name="asset-visibility" class="nav-field__control">
      {% for option in asset_view_options %}
      <option value="{{ option.value }}"{% if loop.first %} selected{% endif %}>{{ option.label }}</option>
      {% endfor %}
    </select>
  </label>
  <button class="primary-button" type="button" data-action="ticket-create-open">New ticket</button>
  <button class="secondary-button" type="button" data-action="ticket-refresh">Refresh</button>
</div>
{% endset %}
{% block content %}
<div class="ticket-workspace" role="region" aria-label="Ticket workspace">
  <aside class="ticket-sidebar" aria-label="Ticket filters">
    {% for group in ticket_filter_groups %}
    {% set is_first_group = loop.first %}
    <div class="ticket-sidebar__group">
      <h3 class="ticket-sidebar__title">{{ group.title }}</h3>
      <div class="ticket-sidebar__items">
        {% for filter in group.filters %}
        <button
          class="ticket-filter-button{% if is_first_group and loop.first %} is-active{% endif %}"
          type="button"
          data-action="ticket-filter"
          data-filter="{{ filter.key }}"
        >
          <span class="ticket-filter-button__icon" aria-hidden="true">{{ filter.icon }}</span>
          <span class="ticket-filter-button__label">{{ filter.label }}</span>
          <span class="ticket-filter-button__count">{{ filter.count }}</span>
        </button>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
    <div class="ticket-sidebar__footer">
      <button class="ticket-label-button" type="button" data-action="ticket-add-label">+ Label</button>
    </div>
  </aside>
  <section class="ticket-board">
    <header class="ticket-board__header">
      <div class="ticket-board__controls">
        <button class="icon-button" type="button" aria-label="Select all tickets" data-action="ticket-select-all">‚òëÔ∏è</button>
        <button class="icon-button" type="button" aria-label="Back" data-action="ticket-back">üîô</button>
        <button class="icon-button" type="button" aria-label="Archive" data-action="ticket-archive">üóÉÔ∏è</button>
        <button class="icon-button" type="button" aria-label="Spam" data-action="ticket-mark-spam">üö´</button>
        <button class="icon-button" type="button" aria-label="Trash" data-action="ticket-trash">üóëÔ∏è</button>
      </div>
      <div class="ticket-board__filters">
        <label class="ticket-search" for="ticket-search-input">
          <span class="ticket-search__icon" aria-hidden="true">üîç</span>
          <input
            id="ticket-search-input"
            type="search"
            placeholder="Search tickets"
            data-role="table-filter"
            aria-controls="ticket-table"
          />
        </label>
        <button class="secondary-button" type="button" data-action="ticket-filter-panel">Filter view</button>
      </div>
    </header>
    <div class="ticket-table-container">
      <table id="ticket-table" class="data-table ticket-table" data-role="sortable-table" data-ticket-table="true">
        <thead>
          <tr>
            <th scope="col" aria-label="Select"></th>
            <th scope="col" data-sort-key="id">ID</th>
            <th scope="col" data-sort-key="subject">Subject</th>
            <th scope="col" data-sort-key="customer">Customer</th>
            <th scope="col" data-sort-key="timestamp">Timestamp</th>
            <th scope="col" data-sort-key="age">Age</th>
            <th scope="col" data-sort-key="team">Team</th>
            <th scope="col" data-sort-key="category">Category</th>
            <th scope="col" aria-label="Update actions"></th>
          </tr>
        </thead>
        <tbody>
          {% for ticket in tickets %}
          <tr data-filter-keys="{{ ticket.filter_tokens | join(' ') }}" data-ticket-id="{{ ticket.id }}">
            <td data-label="Select">
              <div class="ticket-table__select">
                <input type="checkbox" aria-label="Select ticket {{ ticket.id }}" />
                {% if ticket.is_starred %}
                <span class="ticket-table__star" aria-label="Starred ticket">‚òÖ</span>
                {% endif %}
              </div>
            </td>
            <td data-label="ID">
              <a
                href="{{ url_for('ticket_detail', ticket_id=ticket.id) }}"
                class="ticket-id"
                target="_blank"
                rel="noopener noreferrer"
              >
                {{ ticket.id }}
              </a>
            </td>
            <td data-label="Subject">
              <div class="ticket-subject">
                <span class="ticket-subject__title">{{ ticket.subject }}</span>
                <div class="ticket-subject__meta">
                  <span class="status-pill status-pill--{{ ticket.status_token }}">{{ ticket.status }}</span>
                  <span class="badge badge--priority badge--priority-{{ ticket.priority_token }}">{{ ticket.priority }} priority</span>
                  <span class="ticket-subject__channel">{{ ticket.channel }}</span>
                  {% for label in ticket.labels %}
                  <span class="ticket-label">{{ label }}</span>
                  {% endfor %}
                </div>
              </div>
            </td>
            <td data-label="Customer">
              <div class="ticket-customer">
                <span class="ticket-customer__name">{{ ticket.customer }}</span>
                <a class="ticket-customer__email" href="mailto:{{ ticket.customer_email }}">{{ ticket.customer_email }}</a>
              </div>
            </td>
            <td
              data-label="Timestamp"
              data-sort-value="{{ ticket.last_reply_iso }}"
              data-format="datetime"
            >
              {{ ticket.last_reply_iso }}
            </td>
            <td data-label="Age" data-sort-value="{{ ticket.last_reply_iso }}">{{ ticket.age_display }}</td>
            <td data-label="Team">{{ ticket.team }}</td>
            <td data-label="Category">{{ ticket.category }}</td>
            <td data-label="Update" class="ticket-table__actions">
              <a
                class="button button--ghost"
                href="{{ url_for('ticket_detail', ticket_id=ticket.id) }}"
                target="_blank"
                rel="noopener noreferrer"
              >
                Update
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>

<div
  class="modal"
  data-role="ticket-create-modal"
  aria-hidden="true"
  data-open="{{ 'true' if open_ticket_modal else 'false' }}"
>
  <div class="modal__backdrop" data-action="ticket-create-close"></div>
  <div
    class="modal__dialog ticket-create-dialog"
    role="dialog"
    aria-modal="true"
    aria-labelledby="ticket-create-title"
    aria-describedby="ticket-create-description"
  >
    <header class="modal__header">
      <div class="modal__title-group">
        <h2 class="modal__title" id="ticket-create-title">Create new ticket</h2>
        <p class="modal__subtitle" id="ticket-create-description">
          Capture the initial metadata so automations can triage and route the request securely.
        </p>
      </div>
      <button class="button button--ghost modal__close" type="button" data-action="ticket-create-close" aria-label="Close">
        ‚úñÔ∏è
      </button>
    </header>
    <form
      id="ticket-create-form"
      class="modal__body ticket-create-form"
      method="post"
      action="{{ url_for('ticket_create') }}"
      data-role="ticket-create-form"
    >
      {% if new_ticket_errors %}
      <div class="alert alert--error" role="alert">
        <ul>
          {% for message in new_ticket_errors %}
          <li>{{ message }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      <p class="form-message" data-role="form-message" aria-live="polite"></p>
      <div class="form-grid">
        <label class="form-field">
          <span>Subject</span>
          <input type="text" name="subject" value="{{ new_ticket_form.subject }}" autocomplete="off" required />
        </label>
        <label class="form-field">
          <span>Customer</span>
          <input type="text" name="customer" value="{{ new_ticket_form.customer }}" autocomplete="off" required />
        </label>
        <label class="form-field">
          <span>Customer email</span>
          <input type="email" name="customer_email" value="{{ new_ticket_form.customer_email }}" autocomplete="off" required />
        </label>
        <label class="form-field">
          <span>Status</span>
          <select name="status" required>
            {% for option in ticket_status_options %}
            <option value="{{ option }}"{% if option == new_ticket_form.status %} selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="form-field">
          <span>Priority</span>
          <select name="priority" required>
            {% for option in ticket_priority_options %}
            <option value="{{ option }}"{% if option == new_ticket_form.priority %} selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="form-field">
          <span>Team</span>
          <select name="team" required>
            {% for option in ticket_team_options %}
            <option value="{{ option }}"{% if option == new_ticket_form.team %} selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="form-field">
          <span>Assignment</span>
          <select name="assignment" required>
            {% for option in ticket_assignment_options %}
            <option value="{{ option }}"{% if option == new_ticket_form.assignment %} selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="form-field">
          <span>Queue</span>
          <select name="queue" required>
            {% for option in ticket_queue_options %}
            <option value="{{ option }}"{% if option == new_ticket_form.queue %} selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="form-field">
          <span>Category</span>
          <input type="text" name="category" value="{{ new_ticket_form.category }}" autocomplete="off" required />
        </label>
        <label class="form-field form-field--textarea">
          <span>Summary</span>
          <textarea name="summary" rows="3" required>{{ new_ticket_form.summary }}</textarea>
        </label>
      </div>
      <div class="form-actions">
        <button type="submit" class="primary-button">Create ticket</button>
        <button type="button" class="secondary-button" data-action="ticket-create-close">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
